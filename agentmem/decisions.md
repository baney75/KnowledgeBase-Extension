# Memory

## Decisions
- 2026-02-04 Add an "AI Guide" section to every KnowledgeBase Markdown export with formatting rules, source handling, and prompt-injection guardrails.
- 2026-02-04 Study prompts must teach without solving, request student work before checking, and include memory techniques.
- 2026-02-04 Add protected-content fallback: screenshot capture with Markdown wrapper and mark entries non-refreshable.
- 2026-02-04 Support PDF/Markdown import; wrap imports into KnowledgeBase format with AI Guide and chunking.
- 2026-02-04 Improve popup accessibility and clarity: focus-visible styles, aria-live/progress semantics, larger small-text scale, and collapsible learning-needs section.
- 2026-02-04 Tailor study prompt formatting per destination with table-friendly guidance and platform-specific citation/rendering rules.
- 2026-02-05 Save page images locally into a per-page `.assets` folder and list them in an Assets section with relative paths.
- 2026-02-05 Add a KnowledgeBase Library panel to copy Markdown paths and attachment paths quickly.
- 2026-02-05 Support Office imports (`.docx`, `.pptx`, `.xlsx`, plus legacy formats) as attachment wrappers.
- 2026-02-05 Bump KnowledgeBase Markdown schema to 1.3 to include assets metadata and stronger AI guardrails.
- 2026-02-05 Strengthen study prompts with diagnostic questions, explicit tool guidance, and accessibility-adapted scaffolding.
- 2026-02-05 Detect embedded PDF/Office links (iframes and Blackboard Ally preview URLs) and extract them before HTML capture; full-page screenshot fallback for protected pages.
- 2026-02-05 Add Reveal in Folder actions using downloads metadata or filename search to open files in the OS.
- 2026-02-06 Vendor JSZip + PDF.js to enable docx/pptx/xlsx and PDF text extraction inside the extension; fall back to attachment wrappers when extraction fails.
- 2026-02-06 Split full-page screenshot captures into multiple images for very tall pages and list them in the Markdown assets section.
- 2026-02-06 Use authenticated fetch for embedded docs and fall back to direct downloads when CORS/auth blocks extraction.
- 2026-02-08 Fail closed when asset or attachment size is unknown, enforce data URL size limits, and remove unused manifest permissions.
- 2026-02-08 Refresh popup visual hierarchy (Capture section, microcopy, updated palette/shadows) and fix background pattern asset path.
- 2026-02-08 Reduce background texture intensity for VSS (subtle, blurred pattern layer).
- 2026-02-08 If VSS is selected in Learning needs, disable popup background texture entirely to avoid high-frequency line artifacts.
- 2026-02-08 Harden asset/attachment fetching: cap asset count + total bytes, omit credentials for cross-origin HEAD/Range checks, and restrict manifest `host_permissions`/`matches` to http/https only.
- 2026-02-08 KnowledgeBase Library UX: avoid nested accordions/menus inside entries; keep primary actions visible and move secondary actions behind a simple `More` toggle.
- 2026-02-08 KnowledgeBase Library perf: precompute sort/search keys, cache sorted views, and batch DOM insertion (rAF) to keep search/filtering responsive on large libraries.
- 2026-02-09 Student perf: apply popup defaults immediately (don’t block startup on storage reads); localize page images with concurrency-limited header checks + downloads while preserving deterministic selection and hard byte caps.
- 2026-02-09 Content-script perf: embedded-document detection uses targeted selectors and time/node/url budgets for shadow-root scanning (avoid worst-case `querySelectorAll('*')` cost).
- 2026-02-09 Library migration: normalize legacy saved entries by setting `url = source_url` when missing; background actions (save/remove) match by `url` or `source_url` and accept `file_path` as a fallback key.
- 2026-02-10 Context menu: right-click selection/page -> copies a student-safe study prompt via MV3 offscreen document and opens the chosen AI destination.
- 2026-02-10 Library robustness: Library entry actions key off a stable per-entry key (URL or file path or download id), so Remove works even when `url` is missing.
- 2026-02-10 Vendor hardening: PDF.js UMD builds are transpiled with esbuild (ASCII charset, no whitespace minification) to reduce browser parse failures and keep PDF import/extraction available.
- 2026-02-10 Crash fix: `fetchAssetHeaders` returns `response.headers` (not `Response`) so downstream `.get(...)` calls work; prevents popup/background crashes during image localization and embedded-file classification.
- 2026-02-10 Add dev-only TypeScript typecheck (`tsconfig.json` with `allowJs` + `checkJs`) and keep it green (`npm run typecheck`) to prevent message/DOM/asset-handling regressions.
- 2026-02-10 Diagnostics: popup records `kb_last_popup_error` so students can copy “Last popup error” without opening DevTools.
